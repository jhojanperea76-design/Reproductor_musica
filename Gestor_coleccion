package Modelo;

import java.io.BufferedReader;
import java.io.File;
import java.io.FileReader;
import java.io.PrintWriter;
import java.util.ArrayList;
import java.util.List;

/*
Formato simple del archivo data.txt:
L;NombreLista
A;NombreArtista;Genero
C;Titulo;duracion_en_minutos;NombreArtista
AL;NombreLista;TituloCancion
Se procesan l√≠neas en orden.
*/
public class GestorColeccion {
    private List<ListaReproduccion> listas;
    private List<Artista> artistas;
    private List<Cancion> canciones;

    public GestorColeccion() {
        listas = new ArrayList<>();
        artistas = new ArrayList<>();
        canciones = new ArrayList<>();
    }

    public List<ListaReproduccion> getListas() {
        return listas;
    }

    public List<Artista> getArtistas() {
        return artistas;
    }

    public List<Cancion> getCanciones() {
        return canciones;
    }

    public void crearLista(String nombre) {
        listas.add(new ListaReproduccion(nombre));
    }

    public void crearArtista(String nombre, String genero) {
        artistas.add(new Artista(nombre, genero));
    }

    public Artista buscarArtistaPorNombre(String nombre) {
        for (Artista a : artistas) {
            if (a.getNombre().equalsIgnoreCase(nombre)) return a;
        }
        return null;
    }

    public Cancion crearCancion(String titulo, double duracion, Artista artista) {
        Cancion c = new Cancion(titulo, duracion, artista);
        canciones.add(c);
        return c;
    }

    public ListaReproduccion buscarListaPorNombre(String nombre) {
        for (ListaReproduccion l : listas) {
            if (l.getNombre().equalsIgnoreCase(nombre)) return l;
        }
        return null;
    }

    public void agregarCancionALista(String nombreLista, String tituloCancion) {
        ListaReproduccion l = buscarListaPorNombre(nombreLista);
        if (l == null) return;
        for (Cancion c : canciones) {
            if (c.getTitulo().equalsIgnoreCase(tituloCancion)) {
                l.agregarCancion(c);
                return;
            }
        }
    }

    public void cargarDatos(String ruta) {
        File f = new File(ruta);
        if (!f.exists()) return;
        try (BufferedReader br = new BufferedReader(new FileReader(f))) {
            String line;
            while ((line = br.readLine()) != null) {
                line = line.trim();
                if (line.isEmpty()) continue;
                String[] parts = line.split(";");
                String tipo = parts[0];
                if (tipo.equalsIgnoreCase("A") && parts.length >= 3) {
                    crearArtista(parts[1], parts[2]);
                } else if (tipo.equalsIgnoreCase("C") && parts.length >= 4) {
                    String titulo = parts[1];
                    double dur = 0.0;
                    try { dur = Double.parseDouble(parts[2]); } catch (Exception e) {}
                    Artista art = buscarArtistaPorNombre(parts[3]);
                    crearCancion(titulo, dur, art);
                } else if (tipo.equalsIgnoreCase("L") && parts.length >= 2) {
                    crearLista(parts[1]);
                } else if (tipo.equalsIgnoreCase("AL") && parts.length >= 3) {
                    agregarCancionALista(parts[1], parts[2]);
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    public void guardarDatos(String ruta) {
        try (PrintWriter pw = new PrintWriter(new File(ruta))) {
            for (Artista a : artistas) {
                pw.println("A;" + a.getNombre() + ";" + a.getGenero());
            }
            for (Cancion c : canciones) {
                String artName = (c.getArtista() != null) ? c.getArtista().getNombre() : "";
                pw.println("C;" + c.getTitulo() + ";" + c.getDuracion() + ";" + artName);
            }
            for (ListaReproduccion l : listas) {
                pw.println("L;" + l.getNombre());
                for (Cancion c : l.getCanciones()) {
                    pw.println("AL;" + l.getNombre() + ";" + c.getTitulo());
                }
            }
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
